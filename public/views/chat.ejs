<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="styles/style.css">
    <script>
        var socket = io();
        //Funkcja do roobienia nazw pokojów, na razie naiwna
        function makeRoomName(userList) {
            sList = userList.sort();//.map(l => l.id).sort();
            name = ''
            for (const user in sList) {
                name += sList[user].toString();
            }
            return name;
        }
        //funckja do wybierania konkretnego pokoju
        function chooseRoom(homeEmail, mailList) {
            // alert("działa")
            if (mailList == []) {
                alert("Nie możesz (jeszcze) pisać do samego siebie")
            } else {
                room = makeRoomName([homeEmail].concat(mailList));
                socket.emit('room', room);
            } 1
        }
        socket.on('diag', function (data) {
            if (data = "notLogged") {
                var b = document.getElementById('inBody');
                b.innerHTML = "<h1 class='error'>Zaloguj się!</h1>";
                alert("Musisz się zalogować!");
                window.location.href = '../';
            }
        })
        //emitowanie informacji o wyjściu z czatu, żeby usunąć socket z listy aktywnych
        window.addEventListener('beforeunload', function (event) {
            socket.emit('diag', "exit");
        });

        window.addEventListener('load', function () {

            //wyświetlanie czasu
            socket.on('time', function (data) {
                var t = document.getElementById('time');
                t.innerHTML = data;
            });
            //prośba o listę znajomych
            socket.emit('friend list', "start");

            //otrzymanie listy znajomych
            socket.on('friend list', function (list) {
                var fList = document.getElementById('friendBox');
                fList.innerHTML += "<h1>Friends:</h1>";

                for (const friend in list) {
                    //to chyba nie jest najładniejszy sposób, ale działa.
                    //Każdy wpis z listy przyjaciół pakuję w diva
                    var box = `<div 
                    class="dvFriends"
                    id="${"fr" + list[friend].id}" 
                    onclick="chooseRoom('<%= email %>',['${list[friend].email}']);" 
                    style="cursor: pointer;">${list[friend].name}</div>`
                    fList.innerHTML += box;
                };

            });

            //wyświetlanie wiadomości:
            socket.on('chat message', function (data) {
                var msg = document.getElementById('messages');
                msg.innerHTML += '<p class="incmsg">' + data + '</p>' + "<br/>";
            });

            //Wysyłanie wiadomości:
            var btsend = document.getElementById('btsend');
            btsend.addEventListener('click', function () {
                var txtmessage = document.getElementById('txtmessage');
                socket.emit('chat message', txtmessage.value);
            });

        });
    </script>
</head>

<body>
    <div id="inBody">

        <div id="friendBox">
            <input type="button" onClick="location.href='../main'" value="Powrót" />

        </div>
        <div id="chatBox">Aktualny czas na serwerze:
            <br>
            <b>
                <span id="time"></span>
            </b>

            <div>
                <input type='text' id='txtmessage' />
                <input type="button" id='btsend' value="Wyślij" />
                <div id='messages'></div>
            </div>
        </div>

    </div>

</body>

</html>